# backend/src/validators/four_pillars_validator.py 2026-02-15 10:30:00
# 功能：验证四柱组合的正确性，包括六十甲子验证、五虎遁验证和五鼠遁验证

"""
验证四柱组合的正确性
"""

# 天干列表
TIAN_GAN = ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"]

# 地支列表
DI_ZHI = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"]

# 完整的六十甲子表
JIA_ZI_COMBINATIONS = [
    "甲子", "乙丑", "丙寅", "丁卯", "戊辰", "己巳", "庚午", "辛未", "壬申", "癸酉",
    "甲戌", "乙亥", "丙子", "丁丑", "戊寅", "己卯", "庚辰", "辛巳", "壬午", "癸未",
    "甲申", "乙酉", "丙戌", "丁亥", "戊子", "己丑", "庚寅", "辛卯", "壬辰", "癸巳",
    "甲午", "乙未", "丙申", "丁酉", "戊戌", "己亥", "庚子", "辛丑", "壬寅", "癸卯",
    "甲辰", "乙巳", "丙午", "丁未", "戊申", "己酉", "庚戌", "辛亥", "壬子", "癸丑",
    "甲寅", "乙卯", "丙辰", "丁巳", "戊午", "己未", "庚申", "辛酉", "壬戌", "癸亥"
]

# 完整的五虎遁表（年干 × 月支 → 月干）
WU_HU_DUN_FULL = {
    "甲": ["丙寅", "丁卯", "戊辰", "己巳", "庚午", "辛未", "壬申", "癸酉", "甲戌", "乙亥", "丙子", "丁丑"],
    "乙": ["戊寅", "己卯", "庚辰", "辛巳", "壬午", "癸未", "甲申", "乙酉", "丙戌", "丁亥", "戊子", "己丑"],
    "丙": ["庚寅", "辛卯", "壬辰", "癸巳", "甲午", "乙未", "丙申", "丁酉", "戊戌", "己亥", "庚子", "辛丑"],
    "丁": ["壬寅", "癸卯", "甲辰", "乙巳", "丙午", "丁未", "戊申", "己酉", "庚戌", "辛亥", "壬子", "癸丑"], 
    "戊": ["甲寅", "乙卯", "丙辰", "丁巳", "戊午", "己未", "庚申", "辛酉", "壬戌", "癸亥", "甲子", "乙丑"],
    "己": ["丙寅", "丁卯", "戊辰", "己巳", "庚午", "辛未", "壬申", "癸酉", "甲戌", "乙亥", "丙子", "丁丑"],
    "庚": ["戊寅", "己卯", "庚辰", "辛巳", "壬午", "癸未", "甲申", "乙酉", "丙戌", "丁亥", "戊子", "己丑"],
    "辛": ["庚寅", "辛卯", "壬辰", "癸巳", "甲午", "乙未", "丙申", "丁酉", "戊戌", "己亥", "庚子", "辛丑"],
    "壬": ["壬寅", "癸卯", "甲辰", "乙巳", "丙午", "丁未", "戊申", "己酉", "庚戌", "辛亥", "壬子", "癸丑"],
    "癸": ["甲寅", "乙卯", "丙辰", "丁巳", "戊午", "己未", "庚申", "辛酉", "壬戌", "癸亥", "甲子", "乙丑"]
}

# 完整的五鼠遁表（日干 × 时支 → 时干）
WU_SHU_DUN_FULL = {
    "甲": ["甲子", "乙丑", "丙寅", "丁卯", "戊辰", "己巳", "庚午", "辛未", "壬申", "癸酉", "甲戌", "乙亥"],
    "乙": ["丙子", "丁丑", "戊寅", "己卯", "庚辰", "辛巳", "壬午", "癸未", "甲申", "乙酉", "丙戌", "丁亥"],
    "丙": ["戊子", "己丑", "庚寅", "辛卯", "壬辰", "癸巳", "甲午", "乙未", "丙申", "丁酉", "戊戌", "己亥"],
    "丁": ["庚子", "辛丑", "壬寅", "癸卯", "甲辰", "乙巳", "丙午", "丁未", "戊申", "己酉", "庚戌", "辛亥"],
    "戊": ["壬子", "癸丑", "甲寅", "乙卯", "丙辰", "丁巳", "戊午", "己未", "庚申", "辛酉", "壬戌", "癸亥"],
    "己": ["甲子", "乙丑", "丙寅", "丁卯", "戊辰", "己巳", "庚午", "辛未", "壬申", "癸酉", "甲戌", "乙亥"],
    "庚": ["丙子", "丁丑", "戊寅", "己卯", "庚辰", "辛巳", "壬午", "癸未", "甲申", "乙酉", "丙戌", "丁亥"],
    "辛": ["戊子", "己丑", "庚寅", "辛卯", "壬辰", "癸巳", "甲午", "乙未", "丙申", "丁酉", "戊戌", "己亥"],
    "壬": ["庚子", "辛丑", "壬寅", "癸卯", "甲辰", "乙巳", "丙午", "丁未", "戊申", "己酉", "庚戌", "辛亥"],
    "癸": ["壬子", "癸丑", "甲寅", "乙卯", "丙辰", "丁巳", "戊午", "己未", "庚申", "辛酉", "壬戌", "癸亥"]
}

"""
四柱验证和转换工具
提供四柱验证、转换等功能，基于lunar-python库
"""

def verify_pillars(year_pillar: str, month_pillar: str, day_pillar: str, time_pillar: str) -> dict:
    """
    验证四柱组合的合法性
    
    Args:
        year_pillar: 年柱
        month_pillar: 月柱
        day_pillar: 日柱
        time_pillar: 时柱
        
    Returns:
        验证结果字典
    """
    # 验证字符长度
    pillars = [year_pillar, month_pillar, day_pillar, time_pillar]
    for pillar in pillars:
        if len(pillar) != 2:
            return {
                "success": False,
                "error": f"四柱长度错误: {pillar} 应为2个字符",
                "validation_passed": False
            }
    
    # 验证是否为有效的六十甲子组合
    valid_ganzhi = ["甲子", "乙丑", "丙寅", "丁卯", "戊辰", "己巳", "庚午", "辛未", "壬申", "癸酉",
                   "甲戌", "乙亥", "丙子", "丁丑", "戊寅", "己卯", "庚辰", "辛巳", "壬午", "癸未",
                   "甲申", "乙酉", "丙戌", "丁亥", "戊子", "己丑", "庚寅", "辛卯", "壬辰", "癸巳",
                   "甲午", "乙未", "丙申", "丁酉", "戊戌", "己亥", "庚子", "辛丑", "壬寅", "癸卯",
                   "甲辰", "乙巳", "丙午", "丁未", "戊申", "己酉", "庚戌", "辛亥", "壬子", "癸丑",
                   "甲寅", "乙卯", "丙辰", "丁巳", "戊午", "己未", "庚申", "辛酉", "壬戌", "癸亥"]
    
    for pillar in pillars:
        if pillar not in valid_ganzhi:
            return {
                "success": False,
                "error": f"无效的六十甲子组合: {pillar}",
                "validation_passed": False
            }
    
    # 验证五虎遁（年干与月支的关系）
    year_gan = year_pillar[0]  # 年干
    month_zhi = month_pillar[1]  # 月支
    
    # 五虎遁规则：甲己之年丙作首，乙庚之岁戊为头，丙辛必定寻庚起，丁壬壬位顺行流，若问戊癸何方发，甲寅之上好追求
    wuhu_dun_rules = {
        "甲": ["丙", "丁", "戊", "己", "庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁"],
        "乙": ["戊", "己", "庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁", "戊", "己"],
        "丙": ["庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁", "戊", "己", "庚", "辛"],
        "丁": ["壬", "癸", "甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"],
        "戊": ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸", "甲", "乙"],
        "己": ["丙", "丁", "戊", "己", "庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁"],
        "庚": ["戊", "己", "庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁", "戊", "己"],
        "辛": ["庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁", "戊", "己", "庚", "辛"],
        "壬": ["壬", "癸", "甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"],
        "癸": ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸", "甲", "乙"]
    }
    
    # 月支对应的索引
    zhi_to_index = {"寅": 0, "卯": 1, "辰": 2, "巳": 3, "午": 4, "未": 5, 
                   "申": 6, "酉": 7, "戌": 8, "亥": 9, "子": 10, "丑": 11}
    
    if year_gan in wuhu_dun_rules and month_zhi in zhi_to_index:
        expected_gan = wuhu_dun_rules[year_gan][zhi_to_index[month_zhi]]
        actual_gan = month_pillar[0]
        
        if expected_gan != actual_gan:
            return {
                "success": False,
                "error": f"五虎遁验证失败: 年干{year_gan}对应月支{month_zhi}应为{expected_gan}，实际为{actual_gan}",
                "validation_passed": False
            }
    
    # 验证五鼠遁（日干与时支的关系）
    day_gan = day_pillar[0]  # 日干
    time_zhi = time_pillar[1]  # 时支
    
    # 五鼠遁规则：甲己还加甲，乙庚丙作初，丙辛从戊起，丁壬庚子居，戊癸何方发，壬子是真途
    wushu_dun_rules = {
        "甲": ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸", "甲", "乙"],
        "乙": ["丙", "丁", "戊", "己", "庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁"],
        "丙": ["戊", "己", "庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁", "戊", "己"],
        "丁": ["庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁", "戊", "己", "庚", "辛"],
        "戊": ["壬", "癸", "甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"],
        "己": ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸", "甲", "乙"],
        "庚": ["丙", "丁", "戊", "己", "庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁"],
        "辛": ["戊", "己", "庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁", "戊", "己"],
        "壬": ["庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁", "戊", "己", "庚", "辛"],
        "癸": ["壬", "癸", "甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"]
    }
    
    if day_gan in wushu_dun_rules and time_zhi in zhi_to_index:
        expected_gan = wushu_dun_rules[day_gan][zhi_to_index[time_zhi]]
        actual_gan = time_pillar[0]
        
        if expected_gan != actual_gan:
            return {
                "success": False,
                "error": f"五鼠遁验证失败: 日干{day_gan}对应时支{time_zhi}应为{expected_gan}，实际为{actual_gan}",
                "validation_passed": False
            }
    
    # 所有验证通过
    return {
        "success": True,
        "validation_passed": True,
        "message": "四柱组合验证通过"
    }

# 简化的四柱转换方法，只返回Solar.fromBaZi的原始结果
def get_simple_pillars_conversion(year_pillar: str, month_pillar: str, day_pillar: str, time_pillar: str, 
                                  sect: int = 1, base_year: int = 1) -> dict:
    """
    简化的四柱转换方法，只返回Solar.fromBaZi的原始结果
    
    Args:
        year_pillar: 年柱（如：甲子）
        month_pillar: 月柱（如：丙寅）
        day_pillar: 日柱（如：戊辰）
        time_pillar: 时柱（如：壬子）
        sect: 流派（1=晚子时算明天，2=晚子时算当天）
        base_year: 搜索起始年份
        
    Returns:
        包含原始Solar对象列表的字典
    """
    try:
        from lunar_python import Solar
        
        # 直接调用Solar.fromBaZi方法
        matching_solars = Solar.fromBaZi(year_pillar, month_pillar, day_pillar, time_pillar, sect, base_year)
        
        # 返回原始结果
        solar_dates = []
        for solar in matching_solars:
            solar_dates.append({
                "solar_date": solar.toYmdHms()
            })
        
        return {
            "success": True,
            "total_matches": len(matching_solars),
            "solar_dates": solar_dates
        }
        
    except Exception as e:
        return {
            "success": False,
            "error": f"四柱转换过程中发生错误: {str(e)}"
        }
