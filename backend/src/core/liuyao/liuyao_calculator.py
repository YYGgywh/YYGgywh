"""
六爻排盘核心算法模块
基于传统六爻占卜理论，提供完整的排盘计算功能
"""

import random
from typing import List, Dict, Any, Optional
# datetime模块已移除，使用lunar库替代

# 六十四卦数据字典（基于temp_test_liuyao.py中的完整数据）
SIXTY_FOUR_GUA = {
    # 乾宫八卦（完整）
    "111111": {"卦宫": "乾", "宫属": "本宫", "卦名": "乾为天",
               "纳干": ["甲", "甲", "甲", "壬", "壬", "壬"],
               "纳支": ["子", "寅", "辰", "午", "申", "戌"],
               "世应": ["", "", "应", "", "", "世"],               
               "伏干": ["", "甲", "", "", "", ""],
               "伏支": ["", "寅", "", "", "", ""],
               "伏亲": ["", "妻财", "", "", "", ""],
               "世身":"五爻", "月身":"巳", "冲合":"六冲",
               "上卦": "乾", "下卦": "乾", "易序": 1, "宫序": 1},
    "011111": {"卦宫": "乾", "宫属": "一世", "卦名": "天风姤",
              "纳干": ["辛", "辛", "辛", "壬", "壬", "壬"],
               "纳支": ["丑", "亥", "酉", "午", "申", "戌"],
               "六亲": ["父母", "子孙", "兄弟", "官鬼", "兄弟", "父母"],
               "世应": ["世", "", "", "应", "", ""],
               "伏干": ["", "甲", "", "", "", ""],
               "伏支": ["", "寅", "", "", "", ""],
               "伏亲": ["", "妻财", "", "", "", ""],
               "世身":"二爻", "月身":"午", "冲合":"",
               "上卦": "乾", "下卦": "巽", "易序": 44, "宫序": 2},
    "001111": {"卦宫": "乾", "宫属": "二世", "卦名": "天山遁",               
               "纳干": ["丙", "丙", "丙", "壬", "壬", "壬"],
               "纳支": ["辰", "午", "申", "午", "申", "戌"],
               "六亲": ["父母", "官鬼", "兄弟", "官鬼", "兄弟", "父母"],
               "世应": ["", "世", "", "", "应", ""],
               "伏干": ["甲", "甲", "", "", "", ""],
               "伏支": ["子", "寅", "", "", "", ""],
               "伏亲": ["子孙", "妻财", "", "", "", ""],
               "世身":"初爻", "月身":"未", "冲合":"",
               "上卦": "乾", "下卦": "艮", "易序": 33},
    "000111": {"卦宫": "乾", "宫属": "三世", "卦名": "天地否",
               "纳干": ["乙", "乙", "乙", "壬", "壬", "壬"],
               "纳支": ["未", "巳", "卯", "午", "申", "戌"],
               "六亲": ["父母", "官鬼", "妻财", "官鬼", "兄弟", "父母"],
               "世应": ["", "", "世", "", "", "应"],
               "伏干": ["甲", "", "", "", "", ""],
               "伏支": ["子", "", "", "", "", ""],
               "伏亲": ["子孙", "", "", "", "", ""],
               "世身":"四爻", "月身":"申", "冲合":"六合",
               "上卦": "乾", "下卦": "坤", "易序": 12},
    "000011": {"卦宫": "乾", "宫属": "四世", "卦名": "风地观",
               "纳干": ["乙", "乙", "乙", "辛", "辛", "辛"],
               "纳支": ["未", "巳", "卯", "未", "巳", "卯"],
               "六亲": ["父母", "官鬼", "妻财", "父母", "官鬼", "妻财"],
               "世应": ["应", "", "", "世", "", ""],
               "伏干": ["甲", "", "", "", "壬", ""],
               "伏支": ["子", "", "", "", "申", ""],
               "伏亲": ["子孙", "", "", "", "兄弟", ""],
               "世身":"二爻", "月身":"酉", "冲合":"",
               "上卦": "巽", "下卦": "坤", "易序": 20},
    "000001": {"卦宫": "乾", "宫属": "五世", "卦名": "山地剥",
               "纳干": ["乙", "乙", "乙", "丙", "丙", "丙"],
               "纳支": ["未", "巳", "卯", "戌", "子", "寅"],
               "六亲": ["父母", "官鬼", "妻财", "父母", "子孙", "妻财"],
               "世应": ["", "应", "", "", "世", ""],
               "伏干": ["", "", "", "", "壬", ""],
               "伏支": ["", "", "", "", "申", ""],
               "伏亲": ["", "", "", "", "兄弟", ""],
               "伏亲": ["子孙", "", "", "", "兄弟", ""],
               "世身":"初爻", "月身":"戌", "冲合":"",
               "上卦": "艮", "下卦": "坤", "易序": 23},
    "000101": {"卦宫": "乾", "宫属": "游魂", "卦名": "火地晋",
               "纳干": ["乙", "乙", "乙", "己", "己", "己"],
               "纳支": ["未", "巳", "卯", "酉", "未", "巳"],
               "六亲": ["父母", "官鬼", "妻财", "兄弟", "父母", "官鬼"],
               "世应": ["应", "", "", "世", "", ""],
               "伏干": ["甲", "", "", "", "", ""],
               "伏支": ["子", "", "", "", "", ""],
               "伏亲": ["子孙", "", "", "", "", ""],
               "世身":"四爻", "月身":"卯", "冲合":"",
               "上卦": "离", "下卦": "坤", "易序": 35},
    "111101": {"卦宫": "乾", "宫属": "归魂", "卦名": "火天大有",
               "纳干": ["甲", "甲", "甲", "己", "己", "己"],
               "纳支": ["子", "寅", "辰", "酉", "未", "巳"],
               "六亲": ["子孙", "妻财", "父母", "兄弟", "父母", "官鬼"],
               "世应": ["", "", "世", "", "", "应"],
               "伏干": ["", "", "", "", "", ""],
               "伏支": ["", "", "", "", "", ""],
               "伏亲": ["", "", "", "", "", ""],
               "世身":"五爻", "月身":"寅", "冲合":"",
               "上卦": "离", "下卦": "乾", "易序": 14},

    # 兑宫八卦（完整）
    "110110": {"卦宫": "兑", "宫属": "本宫", "卦名": "兑为泽",
               "纳干": ["丁", "丁", "丁", "丁", "丁", "丁"],
               "纳支": ["巳", "卯", "丑", "亥", "酉", "未"],
               "六亲": ["官鬼", "妻财", "父母", "子孙", "兄弟", "父母"],
               "世应": ["", "", "应", "", "", "世"],
               "伏干": ["", "", "", "", "", ""],
               "伏支": ["", "", "", "", "", ""],
               "伏亲": ["", "", "", "", "", ""],
               "世身":"二爻", "月身":"亥", "冲合":"六冲",
               "上卦": "兑", "下卦": "兑", "易序": 58},
    "010110": {"卦宫": "兑", "宫属": "一世", "卦名": "泽水困",
               "纳干": ["戊", "戊", "戊", "丁", "丁", "丁"],
               "纳支": ["寅", "辰", "午", "亥", "酉", "未"],
               "六亲": ["妻财", "父母", "官鬼", "子孙", "兄弟", "父母"],
               "世应": ["世", "", "", "应", "", ""],
               "伏干": ["", "", "", "", "", ""],
               "伏支": ["", "", "", "", "", ""],
               "伏亲": ["", "", "", "", "", ""],
               "世身":"三爻", "月身":"午", "冲合":"六合",
               "上卦": "兑", "下卦": "坎", "易序": 47,},
    "000110": {"卦宫": "兑", "宫属": "二世", "卦名": "泽地萃",
               "纳干": ["乙", "乙", "乙", "丁", "丁", "丁"],
               "纳支": ["未", "巳", "卯", "亥", "酉", "未"],
               "六亲": ["父母", "官鬼", "妻财", "子孙", "兄弟", "父母"],
               "世应": ["", "世", "", "", "应", ""],
               "伏干": ["", "", "", "", "", ""],
               "伏支": ["", "", "", "", "", ""],
               "伏亲": ["", "", "", "", "", ""],
               "世身":"上爻", "月身":"未", "冲合":"",
               "上卦": "兑", "下卦": "坤", "易序": 45,},
    "001110": {"卦宫": "兑", "宫属": "三世", "卦名": "泽山咸",
               "纳干": ["丙", "丙", "丙", "丁", "丁", "丁"],
               "纳支": ["辰", "午", "申", "亥", "酉", "未"],
               "六亲": ["父母", "官鬼", "兄弟", "子孙", "兄弟", "父母"],
               "世应": ["", "", "世", "", "", "应"],
               "伏干": ["", "丁", "", "", "", ""],
               "伏支": ["", "卯", "", "", "", ""],
               "伏亲": ["", "妻财", "", "", "", ""],
               "世身":"三爻", "月身":"寅", "冲合":"",
               "上卦": "兑", "下卦": "艮", "易序": 31,},
    "001010": {"卦宫": "兑", "宫属": "四世", "卦名": "水山蹇",
               "纳干": ["丙", "丙", "丙", "戊", "戊", "戊"],
               "纳支": ["辰", "午", "申", "申", "戌", "子"],
               "六亲": ["父母", "官鬼", "兄弟", "兄弟", "父母", "子孙"],
               "世应": ["应", "", "", "世", "", ""],
               "伏干": ["", "丁", "", "", "", ""],
               "伏支": ["", "卯", "", "", "", ""],
               "伏亲": ["", "妻财", "", "", "", ""],
               "世身":"三爻", "月身":"酉", "冲合":"",
               "上卦": "坎", "下卦": "艮", "易序": 39,},
    "001000": {"卦宫": "兑", "宫属": "五世", "卦名": "地山谦",
               "纳干": ["丙", "丙", "丙", "癸", "癸", "癸"],
               "纳支": ["辰", "午", "申", "丑", "亥", "酉"],
               "六亲": ["父母", "官鬼", "兄弟", "父母", "子孙", "兄弟"],
               "世应": ["", "应", "", "", "世", ""],
               "伏干": ["", "丁", "", "", "", ""],
               "伏支": ["", "卯", "", "", "", ""],
               "伏亲": ["", "妻财", "", "", "", ""],
               "世身":"上爻", "月身":"戌", "冲合":"",
               "上卦": "坤", "下卦": "艮", "易序": 15,},
    "001100": {"卦宫": "兑", "宫属": "游魂", "卦名": "雷山小过",
               "纳干": ["丙", "丙", "丙", "庚", "庚", "庚"],
               "纳支": ["辰", "午", "申", "午", "申", "戌"],
               "六亲": ["父母", "官鬼", "兄弟", "官鬼", "兄弟", "父母"],
               "世应": ["应", "", "", "世", "", ""],
               "伏干": ["", "丁", "", "丁", "", ""],
               "伏支": ["", "卯", "", "亥", "", ""],
               "伏亲": ["", "妻财", "", "子孙", "", ""],
               "世身":"初爻", "月身":"卯", "冲合":"",
               "上卦": "震", "下卦": "艮", "易序": 62,},
    "110100": {"卦宫": "兑", "宫属": "归魂", "卦名": "雷泽归妹", 
               "纳干": ["丁", "丁", "丁", "庚", "庚", "庚"],
               "纳支": ["巳", "卯", "丑", "午", "申", "戌"],
               "六亲": ["官鬼", "妻财", "父母", "官鬼", "兄弟", "父母"],
               "世应": ["", "", "世", "", "", "应"],
               "伏干": ["", "", "", "丁", "", ""],
               "伏支": ["", "", "", "亥", "", ""],
               "伏亲": ["", "", "", "子孙", "", ""],
               "世身":"二爻", "月身":"申", "冲合":"",
               "上卦": "震", "下卦": "兑", "易序": 54,},

    # 离宫八卦（完整）
    "101101": {"卦宫": "离", "宫属": "本宫", "卦名": "离为火",
               "纳干": ["己", "己", "己", "己", "己", "己"],
               "纳支": ["卯", "丑", "亥", "酉", "未", "巳"],
               "六亲": ["父母", "妻财", "官鬼", "妻财", "子孙", "兄弟"],
               "世应": ["", "", "应", "", "", "世"],
               "伏干": ["", "", "", "", "", ""],
               "伏支": ["", "", "", "", "", ""],
               "伏亲": ["", "", "", "", "", ""],
               "世身":"上爻", "月身":"巳", "冲合":"六冲",
               "上卦": "离", "下卦": "离", "易序": 30,},
    "001101": {"卦宫": "离", "宫属": "一世", "卦名": "火山旅",
               "纳干": ["丙", "丙", "丙", "己", "己", "己"],
               "纳支": ["辰", "午", "申", "酉", "未", "巳"],
               "六亲": ["子孙", "兄弟", "妻财", "妻财", "子孙", "兄弟"],
               "世应": ["世", "", "", "应", "", ""],
               "伏干": ["己", "", "己", "", "", ""],
               "伏支": ["卯", "", "亥", "", "", ""],
               "伏亲": ["父母", "", "", "官鬼", "", ""],
               "世身":"五爻", "月身":"午", "冲合":"六合",
               "上卦": "离", "下卦": "艮", "易序": 56,},
    "011101": {"卦宫": "离", "宫属": "二世", "卦名": "火风鼎",
               "纳干": ["辛", "辛", "辛", "己", "己", "己"],
               "纳支": ["丑", "亥", "酉", "酉", "未", "巳"],
               "六亲": ["子水", "官鬼", "妻财", "妻财", "子孙", "兄弟"],
               "世应": ["", "世", "", "", "应", ""],
               "伏干": ["己", "", "", "", "", ""],
               "伏支": ["卯", "", "", "", "", ""],
               "伏亲": ["父母", "", "", "", "", ""],
               "世身":"上爻", "月身":"丑", "冲合":"",
               "上卦": "离", "下卦": "巽", "易序": 50,},
    "010101": {"卦宫": "离", "宫属": "三世", "卦名": "火水未济",
               "纳干": ["戊", "戊", "戊", "己", "己", "己"],
               "纳支": ["寅", "辰", "午", "酉", "未", "巳"],
               "六亲": ["父母", "子孙", "兄弟", "妻财", "子孙", "兄弟"],
               "世应": ["", "", "世", "", "", "应"],
               "伏干": ["", "", "己", "", "", ""],
               "伏支": ["", "", "亥", "", "", ""],
               "伏亲": ["", "", "官鬼", "", "", ""],
               "世身":"初爻", "月身":"申", "冲合":"",
               "上卦": "离", "下卦": "坎", "易序": 64,},
    "010001": {"卦宫": "离", "宫属": "四世", "卦名": "山水蒙",
               "纳干": ["戊", "戊", "戊", "丙", "丙", "丙"],
               "纳支": ["寅", "辰", "午", "戌", "子", "寅"],
               "六亲": ["父母", "子孙", "兄弟", "子孙", "官鬼", "父母"],
               "世应": ["应", "", "", "世", "", ""],
               "伏干": ["", "", "", "己", "", ""],
               "伏支": ["", "", "", "酉", "", ""],
               "伏亲": ["", "", "", "妻财", "", ""],
               "世身":"五爻", "月身":"酉", "冲合":"",
               "上卦": "艮", "下卦": "坎", "易序": 4,},
    "010011": {"卦宫": "离", "宫属": "五世", "卦名": "风水涣",
               "纳干": ["戊", "戊", "戊", "辛", "辛", "辛"],
               "纳支": ["寅", "辰", "午", "未", "巳", "卯"],
               "六亲": ["父母", "子孙", "兄弟", "子孙", "兄弟", "父母"],
               "世应": ["", "应", "", "", "世", ""],
               "伏干": ["", "", "己", "己", "", ""],
               "伏支": ["", "", "亥", "酉", "", ""],
               "伏亲": ["", "", "官鬼", "妻财", "", ""],
               "世身":"上爻", "月身":"辰", "冲合":"",
               "上卦": "巽", "下卦": "坎", "易序": 59,},
    "010111": {"卦宫": "离", "宫属": "游魂", "卦名": "天水讼",
               "纳干": ["戊", "戊", "戊", "壬", "壬", "壬"],
               "纳支": ["寅", "辰", "午", "午", "申", "戌"],
               "六亲": ["父母", "子孙", "兄弟", "兄弟", "妻财", "子孙"],
               "世应": ["应", "", "", "世", "", ""],
               "伏干": ["", "", "己", "", "", ""],
               "伏支": ["", "", "亥", "", "", ""],
               "伏亲": ["", "", "官鬼", "", "", ""],
               "世身":"初爻", "月身":"卯", "冲合":"",
               "上卦": "乾", "下卦": "坎", "易序": 6,},
    "101111": {"卦宫": "离", "宫属": "归魂", "卦名": "天火同人",
               "纳干": ["己", "己", "己", "壬", "壬", "壬"],
               "纳支": ["卯", "丑", "亥", "午", "申", "戌"],
               "六亲": ["父母", "子孙", "官鬼", "兄弟", "妻财", "子孙"],
               "世应": ["", "", "世", "", "", "应"],
               "伏干": ["", "", "", "", "", ""],
               "伏支": ["", "", "", "", "", ""],
               "伏亲": ["", "", "", "", "", ""],
               "世身":"上爻", "月身":"寅", "冲合":"",
               "上卦": "乾", "下卦": "离", "易序": 13,},

    # 震宫八卦（完整）
    "100100": {"卦宫": "震", "宫属": "本宫", "卦名": "震为雷",
               "纳干": ["庚", "庚", "庚", "庚", "庚", "庚"],
               "纳支": ["子", "寅", "辰", "午", "申", "戌"],
               "六亲": ["父母", "兄弟", "妻财", "子孙", "官鬼", "妻财"],
               "世应": ["", "", "应", "", "", "世"],
               "伏干": ["", "", "", "", "", ""],
               "伏支": ["", "", "", "", "", ""],
               "伏亲": ["", "", "", "", "", ""],
               "世身":"五爻", "月身":"亥", "冲合":"六冲",
               "上卦": "震", "下卦": "震", "易序": 51,},
    "000100": {"卦宫": "震", "宫属": "一世", "卦名": "雷地豫",
               "纳干": ["乙", "乙", "乙", "庚", "庚", "庚"],
               "纳支": ["未", "巳", "卯", "午", "申", "戌"],
               "六亲": ["妻财", "子孙", "兄弟", "子孙", "官鬼", "妻财"], 
               "世应": ["世", "", "", "应", "", ""],               
               "伏干": ["庚", "", "", "", "", ""],
               "伏支": ["子", "", "", "", "", ""],
               "伏亲": ["父母", "", "", "", "", ""],
               "世身":"二爻", "月身":"午", "冲合":"六合",
               "上卦": "震", "下卦": "坤", "易序": 16,},
    "010100": {"卦宫": "震", "宫属": "二世", "卦名": "雷水解",
               "纳干": ["戊", "戊", "戊", "庚", "庚", "庚"],
               "纳支": ["寅", "辰", "午", "午", "申", "戌"],
               "六亲": ["兄弟", "妻财", "子孙", "子孙", "官鬼", "妻财"],
               "世应": ["", "世", "", "", "应", ""],       
               "伏干": ["庚", "", "", "", "", ""],
               "伏支": ["子", "", "", "", "", ""],
               "伏亲": ["父母", "", "", "", "", ""],
               "世身":"五爻", "月身":"丑", "冲合":"",
               "上卦": "震", "下卦": "坎", "易序": 40,},
    "011100": {"卦宫": "震", "宫属": "三世", "卦名": "雷风恒",
               "纳干": ["辛", "辛", "辛", "庚", "庚", "庚"],
               "纳支": ["丑", "亥", "酉", "午", "申", "戌"],
               "六亲": ["妻财", "父母", "官鬼", "子孙", "官鬼", "妻财"],
               "世应": ["", "", "世", "", "", "应"],
               "伏干": ["", "庚", "", "", "", ""],
               "伏支": ["", "寅", "", "", "", ""],
               "伏亲": ["", "兄弟", "", "", "", ""],
               "世身":"四爻", "月身":"寅", "冲合":"",
               "上卦": "震", "下卦": "巽", "易序": 32,},
    "011000": {"卦宫": "震", "宫属": "四世", "卦名": "地风升",
               "纳干": ["辛", "辛", "辛", "癸", "癸", "癸"],
               "纳支": ["丑", "亥", "酉", "丑", "亥", "酉"],
               "六亲": ["妻财", "父母", "官鬼", "妻财", "父母", "官鬼"],
               "世应": ["应", "", "", "世", "", ""],
               "伏干": ["", "庚", "", "庚", "", ""],
               "伏支": ["", "寅", "", "午", "", ""],
               "伏亲": ["", "兄弟", "", "子孙", "", ""],
               "世身":"二爻", "月身":"酉", "冲合":"",
               "上卦": "坤", "下卦": "巽", "易序": 46,},
    "011010": {"卦宫": "震", "宫属": "五世", "卦名": "水风井",
               "纳干": ["辛", "辛", "辛", "戊", "戊", "戊"],
               "纳支": ["丑", "亥", "酉", "申", "戌", "子"],
               "六亲": ["妻财", "父母", "官鬼", "官鬼", "妻财", "父母"],
               "世应": ["", "应", "", "", "世", ""],
               "伏干": ["", "庚", "", "庚", "", ""],
               "伏支": ["", "寅", "", "午", "", ""],
               "伏亲": ["", "兄弟", "", "子孙", "", ""],
               "世身":"五爻", "月身":"辰", "冲合":"",
               "上卦": "坎", "下卦": "巽", "易序": 48,},
    "011110": {"卦宫": "震", "宫属": "游魂", "卦名": "泽风大过",
               "纳干": ["辛", "辛", "辛", "丁", "丁", "丁"],
               "纳支": ["丑", "亥", "酉", "亥", "酉", "未"],
               "六亲": ["妻财", "父母", "官鬼", "父母", "官鬼", "妻财"],
               "世应": ["应", "", "", "世", "", ""],
               "伏干": ["", "庚", "", "庚", "", ""],
               "伏支": ["", "寅", "", "午", "", ""],
               "伏亲": ["", "兄弟", "", "子孙", "", ""],
               "世身":"上爻", "月身":"卯", "冲合":"",
               "上卦": "兑", "下卦": "巽", "易序": 28,},
    "100110": {"卦宫": "震", "宫属": "归魂", "卦名": "泽雷随",
               "纳干": ["庚", "庚", "庚", "丁", "丁", "丁"],
               "纳支": ["子", "寅", "辰", "亥", "酉", "未"],
               "六亲": ["父母", "兄弟", "妻财", "父母", "官鬼", "妻财"],
               "世应": ["", "", "世", "", "", "应"],
               "伏干": ["", "", "", "庚", "", ""],
               "伏支": ["", "", "", "午", "", ""],
               "伏亲": ["", "", "", "子孙", "", ""],
               "世身":"五爻", "月身":"申", "冲合":"",
               "上卦": "兑", "下卦": "震", "易序": 17,},

    # 巽宫八卦（完整）
    "011011": {"卦宫": "巽", "宫属": "本宫", "卦名": "巽为风",
               "纳干": ["辛", "辛", "辛", "辛", "辛", "辛"],
               "纳支": ["丑", "亥", "酉", "未", "巳", "卯"],
               "六亲": ["妻财", "父母", "官鬼", "妻财", "子孙", "兄弟"],
               "世应": ["", "", "应", "", "", "世"],
               "伏干": ["", "", "", "", "", ""],
               "伏支": ["", "", "", "", "", ""],
               "伏亲": ["", "", "", "", "", ""],
               "世身":"四爻", "月身":"巳", "冲合":"六冲",
               "上卦": "巽", "下卦": "巽", "易序": 57,},
    "111011": {"卦宫": "巽", "宫属": "一世", "卦名": "风天小畜",
               "纳干": ["甲", "甲", "甲", "辛", "辛", "辛"],
               "纳支": ["子", "寅", "辰", "未", "巳", "卯"],
               "六亲": ["父母", "兄弟", "妻财", "妻财", "子孙", "兄弟"],
               "世应": ["世", "", "", "应", "", ""],
               "伏干": ["", "", "辛", "", "", ""],
               "伏支": ["", "", "酉", "", "", ""],
               "伏亲": ["", "", "官鬼", "", "", ""],
               "世身":"初爻", "月身":"子", "冲合":"",
               "上卦": "巽", "下卦": "乾", "易序": 9,},
    "101011": {"卦宫": "巽", "宫属": "二世", "卦名": "风火家人",
               "纳干": ["己", "己", "己", "辛", "辛", "辛"],
               "纳支": ["卯", "丑", "亥", "未", "巳", "卯"],
               "六亲": ["兄弟", "妻财", "父母", "妻财", "子孙", "兄弟"],
               "世应": ["", "世", "", "", "应", ""],
               "伏干": ["", "", "辛", "", "", ""],
               "伏支": ["", "", "酉", "", "", ""],
               "伏亲": ["", "", "官鬼", "", "", ""],
               "世身":"二爻", "月身":"未", "冲合":"",
               "上卦": "巽", "下卦": "离", "易序": 37,},
    "100011": {"卦宫": "巽", "宫属": "三世", "卦名": "风雷益",  
               "纳干": ["庚", "庚", "庚", "辛", "辛", "辛"],
               "纳支": ["子", "寅", "辰", "未", "巳", "卯"],
               "六亲": ["父母", "兄弟", "妻财", "妻财", "子孙", "兄弟"],
               "世应": ["", "", "世", "", "", "应"],
               "伏干": ["", "", "辛", "", "", ""],
               "伏支": ["", "", "酉", "", "", ""],
               "伏亲": ["", "", "官鬼", "", "", ""],
               "世身":"五爻", "月身":"申", "冲合":"",
               "上卦": "巽", "下卦": "震", "易序": 42,},
    "100111": {"卦宫": "巽", "宫属": "四世", "卦名": "天雷无妄",
               "纳干": ["庚", "庚", "庚", "壬", "壬", "壬"],
               "纳支": ["子", "寅", "辰", "午", "申", "戌"],
               "六亲": ["父母", "兄弟", "妻财", "子孙", "官鬼", "妻财"],
               "世应": ["应", "", "", "世", "", ""],
               "伏干": ["", "", "", "", "", ""],
               "伏支": ["", "", "", "", "", ""],
               "伏亲": ["", "", "", "", "", ""],
               "世身":"初爻", "月身":"卯", "冲合":"六冲",
               "上卦": "乾", "下卦": "震", "易序": 25,},
    "100101": {"卦宫": "巽", "宫属": "五世", "卦名": "火雷噬嗑",
               "纳干": ["庚", "庚", "庚", "己", "己", "己"],
               "纳支": ["子", "寅", "辰", "酉", "未", "巳"],
               "六亲": ["父母", "兄弟", "妻财", "官鬼", "妻财", "子孙"],
               "世应": ["", "应", "", "", "世", ""],
               "伏干": ["", "", "", "", "", ""],
               "伏支": ["", "", "", "", "", ""],
               "伏亲": ["", "", "", "", "", ""],
               "世身":"二爻", "月身":"戌", "冲合":"",
               "上卦": "离", "下卦": "震", "易序": 21,},
    "100001": {"卦宫": "巽", "宫属": "游魂", "卦名": "山雷颐",
               "纳干": ["庚", "庚", "庚", "丙", "丙", "丙"],
               "纳支": ["子", "寅", "辰", "戌", "子", "寅"],
               "六亲": ["父母", "兄弟", "妻财", "妻财", "父母", "兄弟"],
               "世应": ["应", "", "", "世", "", ""],
               "伏干": ["", "", "辛", "", "辛", ""],
               "伏支": ["", "", "酉", "", "巳", ""],
               "伏亲": ["", "", "官鬼", "", "子孙", ""],
               "世身":"五爻", "月身":"酉", "冲合":"",
               "上卦": "艮", "下卦": "震", "易序": 27,},
    "011001": {"卦宫": "巽", "宫属": "归魂", "卦名": "山风蛊",
               "纳干": ["辛", "辛", "辛", "丙", "丙", "丙"],
               "纳支": ["丑", "亥", "酉", "戌", "子", "寅"],
               "六亲": ["妻财", "父母", "官鬼", "妻财", "父母", "兄弟"],
               "世应": ["", "", "世", "", "", "应"],
               "伏干": ["", "", "", "", "辛", ""],
               "伏支": ["", "", "", "", "巳", ""],
               "伏亲": ["", "", "", "", "子孙", ""],
               "世身":"四爻", "月身":"寅", "冲合":"",
               "上卦": "艮", "下卦": "巽", "易序": 18,},

    # 坎宫八卦（完整）
    "010010": {"卦宫": "坎", "宫属": "本宫", "卦名": "坎为水",
               "纳干": ["戊", "戊", "戊", "戊", "戊", "戊"],
               "纳支": ["寅", "辰", "午", "申", "戌", "子"],
               "六亲": ["子孙", "官鬼", "妻财", "父母", "官鬼", "兄弟"],
               "世应": ["", "", "应", "", "", "世"],
               "伏干": ["", "", "", "", "", ""],
               "伏支": ["", "", "", "", "", ""],
               "伏亲": ["", "", "", "", "", ""],
               "世身":"初爻", "月身":"亥", "冲合":"六冲",
               "上卦": "坎", "下卦": "坎", "易序": 29,},
    "110010": {"卦宫": "坎", "宫属": "一世", "卦名": "水泽节",
               "纳干": ["丁", "丁", "丁", "戊", "戊", "戊"],
               "纳支": ["巳", "卯", "丑", "申", "戌", "子"],
               "六亲": ["妻财", "子孙", "官鬼", "父母", "官鬼", "兄弟"],
               "世应": ["世", "", "", "应", "", ""],
               "伏干": ["", "", "", "", "", ""],
               "伏支": ["", "", "", "", "", ""],
               "伏亲": ["", "", "", "", "", ""],
               "世身":"上爻", "月身":"子", "冲合":"六合",
               "上卦": "坎", "下卦": "兑", "易序": 60,},
    "100010": {"卦宫": "坎", "宫属": "二世", "卦名": "水雷屯",
               "纳干": ["庚", "庚", "庚", "戊", "戊", "戊"],
               "纳支": ["子", "寅", "辰", "申", "戌", "子"],
               "六亲": ["兄弟", "子孙", "官鬼", "父母", "官鬼", "兄弟"],
               "世应": ["", "世", "", "", "应", ""],
               "伏干": ["", "", "戊", "", "", ""],
               "伏支": ["", "", "午", "", "", ""],
               "伏亲": ["", "", "妻财", "", "", ""],
               "世身":"三爻", "月身":"未", "冲合":"",
               "上卦": "坎", "下卦": "震", "易序": 3,},
    "101010": {"卦宫": "坎", "宫属": "三世", "卦名": "水火既济",
               "纳干": ["己", "己", "己", "戊", "戊", "戊"],
               "纳支": ["卯", "丑", "亥", "申", "戌", "子"],
               "六亲": ["子孙", "官鬼", "兄弟", "父母", "官鬼", "兄弟"],
               "世应": ["", "", "世", "", "", "应"],
               "伏干": ["", "", "戊", "", "", ""],
               "伏支": ["", "", "午", "", "", ""],
               "伏亲": ["", "", "妻财", "", "", ""],
               "世身":"上爻", "月身":"寅", "冲合":"",
               "上卦": "坎", "下卦": "离", "易序": 63,},
    "101110": {"卦宫": "坎", "宫属": "四世", "卦名": "泽火革",
               "纳干": ["己", "己", "己", "丁", "丁", "丁"],
               "纳支": ["卯", "丑", "亥", "亥", "酉", "未"],
               "六亲": ["子孙", "官鬼", "兄弟", "兄弟", "父母", "官鬼"],
               "世应": ["应", "", "", "世", "", ""],
               "伏干": ["", "", "戊", "", "", ""],
               "伏支": ["", "", "午", "", "", ""],
               "伏亲": ["", "", "妻财", "", "", ""],
               "世身":"上爻", "月身":"卯", "冲合":"",
               "上卦": "兑", "下卦": "离", "易序": 49,},
    "101100": {"卦宫": "坎", "宫属": "五世", "卦名": "雷火丰",
               "纳干": ["己", "己", "己", "庚", "庚", "庚"],
               "纳支": ["卯", "丑", "亥", "午", "申", "戌"],
               "六亲": ["子孙", "官鬼", "兄弟", "妻财", "父母", "官鬼"],
               "世应": ["", "应", "", "", "世", ""],
               "伏干": ["", "", "", "", "", ""],
               "伏支": ["", "", "", "", "", ""],
               "伏亲": ["", "", "", "", "", ""],
               "世身":"三爻", "月身":"戌", "冲合":"",
               "上卦": "震", "下卦": "离", "易序": 55,},
    "101000": {"卦宫": "坎", "宫属": "游魂", "卦名": "地火明夷",
               "纳干": ["己", "己", "己", "癸", "癸", "癸"],
               "纳支": ["卯", "丑", "亥", "丑", "亥", "酉"],
               "六亲": ["子孙", "官鬼", "兄弟", "官鬼", "兄弟", "父母"],
               "世应": ["应", "", "", "世", "", ""],
               "伏干": ["", "", "戊", "", "", ""],
               "伏支": ["", "", "午", "", "", ""],
               "伏亲": ["", "", "妻财", "", "", ""],
               "世身":"二爻", "月身":"酉", "冲合":"",
               "上卦": "坤", "下卦": "离", "易序": 36,},
    "010000": {"卦宫": "坎", "宫属": "归魂", "卦名": "地水师",
               "纳干": ["戊", "戊", "戊", "癸", "癸", "癸"],
               "纳支": ["寅", "辰", "午", "丑", "亥", "酉"],
               "六亲": ["子孙", "官鬼", "妻财", "官鬼", "兄弟", "父母"],
               "世应": ["", "", "世", "", "", "应"],
               "伏干": ["", "", "", "", "", ""],
               "伏支": ["", "", "", "", "", ""],
               "伏亲": ["", "", "", "", "", ""],
               "世身":"初爻", "月身":"申", "冲合":"",
               "上卦": "坤", "下卦": "坎", "易序": 7,},

    # 艮宫八卦（完整）
    "001001": {"卦宫": "艮", "宫属": "本宫", "卦名": "艮为山",
               "纳干": ["丙", "丙", "丙", "丙", "丙", "丙"],
               "纳支": ["辰", "午", "申", "戌", "子", "寅"],
               "六亲": ["兄弟", "父母", "子孙", "兄弟", "妻财", "官鬼"],
               "世应": ["", "", "应", "", "", "世"],
               "伏干": ["", "", "", "", "", ""],
               "伏支": ["", "", "", "", "", ""],
               "伏亲": ["", "", "", "", "", ""],
               "世身":"三爻", "月身":"巳", "冲合":"六冲",
               "上卦": "艮", "下卦": "艮", "易序": 52,},
    "101001": {"卦宫": "艮", "宫属": "一世", "卦名": "山火贲",
               "纳干": ["己", "己", "己", "丙", "丙", "丙"],
               "纳支": ["卯", "丑", "亥", "戌", "子", "寅"],
               "六亲": ["官鬼", "兄弟", "妻财", "兄弟", "妻财", "官鬼"],
               "世应": ["世", "", "", "应", "", ""],
               "伏干": ["", "丙", "丙", "", "", ""],
               "伏支": ["", "午", "申", "", "", ""],
               "伏亲": ["", "父母", "子孙", "", "", ""],
               "世身":"四爻", "月身":"子", "冲合":"六合",
               "上卦": "艮", "下卦": "离", "易序": 22,},
    "111001": {"卦宫": "艮", "宫属": "二世", "卦名": "山天大畜",
               "纳干": ["甲", "甲", "甲", "丙", "丙", "丙"],
               "纳支": ["子", "寅", "辰", "戌", "子", "寅"],
               "六亲": ["妻财", "官鬼", "兄弟", "兄弟", "妻财", "官鬼"],
               "世应": ["", "世", "", "", "应", ""],
               "伏干": ["", "丙", "丙", "", "", ""],
               "伏支": ["", "午", "申", "", "", ""],
               "伏亲": ["", "父母", "子孙", "", "", ""],
               "世身":"三爻", "月身":"丑", "冲合":"",
               "上卦": "艮", "下卦": "乾", "易序": 26,},
    "110001": {"卦宫": "艮", "宫属": "三世", "卦名": "山泽损",
               "纳干": ["丁", "丁", "丁", "丙", "丙", "丙"],
               "纳支": ["巳", "卯", "丑", "戌", "子", "寅"],
               "六亲": ["父母", "官鬼", "兄弟", "兄弟", "妻财", "官鬼"],
               "世应": ["", "", "世", "", "", "应"],
               "伏干": ["", "", "丙", "", "", ""],
               "伏支": ["", "", "申", "", "", ""],
               "伏亲": ["", "", "子孙", "", "", ""],
               "世身":"二爻", "月身":"申", "冲合":"",
               "上卦": "艮", "下卦": "兑", "易序": 41,},
    "110101": {"卦宫": "艮", "宫属": "四世", "卦名": "火泽睽",
               "纳干": ["丁", "丁", "丁", "己", "己", "己"],
               "纳支": ["巳", "卯", "丑", "酉", "未", "巳"],
               "六亲": ["父母", "官鬼", "兄弟", "子水", "兄弟", "父母"],
               "世应": ["应", "", "", "世", "", ""],
               "伏干": ["", "", "", "", "丙", ""],
               "伏支": ["", "", "", "", "子", ""],
               "伏亲": ["", "", "", "", "妻财", ""],
               "世身":"四爻", "月身":"卯", "冲合":"",
               "上卦": "离", "下卦": "兑", "易序": 38,},
    "110111": {"卦宫": "艮", "宫属": "五世", "卦名": "天泽履",
               "纳干": ["丁", "丁", "丁", "壬", "壬", "壬"],
               "纳支": ["巳", "卯", "丑", "午", "申", "戌"],
               "六亲": ["父母", "官鬼", "兄弟", "父母", "子孙", "兄弟"],
               "世应": ["", "应", "", "", "世", ""],
               "伏干": ["", "", "", "", "丙", ""],
               "伏支": ["", "", "", "", "子", ""],
               "伏亲": ["", "", "", "", "妻财", ""],
               "世身":"三爻", "月身":"辰", "冲合":"",
               "上卦": "乾", "下卦": "兑", "易序": 10,},
    "110011": {"卦宫": "艮", "宫属": "游魂", "卦名": "风泽中孚",
               "纳干": ["丁", "丁", "丁", "辛", "辛", "辛"],
               "纳支": ["巳", "卯", "丑", "未", "巳", "卯"],
               "六亲": ["父母", "官鬼", "兄弟", "兄弟", "父母", "官鬼"],
               "世应": ["应", "", "", "世", "", ""],
               "伏干": ["", "丙", "", "", "丙", ""],
               "伏支": ["", "申", "", "", "子", ""],
               "伏亲": ["", "子孙", "", "", "妻财", ""],
               "世身":"二爻", "月身":"酉", "冲合":"",
               "上卦": "巽", "下卦": "兑", "易序": 61,},
    "001011": {"卦宫": "艮", "宫属": "归魂", "卦名": "风山渐",
               "纳干": ["丙", "丙", "丙", "辛", "辛", "辛"],
               "纳支": ["辰", "午", "申", "未", "巳", "卯"],
               "六亲": ["兄弟", "父母", "子孙", "兄弟", "父母", "官鬼"],
               "世应": ["", "", "世", "", "", "应"],
               "伏干": ["", "", "", "", "丙", ""],
               "伏支": ["", "", "", "", "子", ""],
               "伏亲": ["", "", "", "", "妻财", ""],
               "世身":"三爻", "月身":"寅", "冲合":"",
               "上卦": "巽", "下卦": "艮", "易序": 53,},

    # 坤宫八卦（完整）
    "000000": {"卦宫": "坤", "宫属": "本宫", "卦名": "坤为地",
               "纳干": ["乙", "乙", "乙", "癸", "癸", "癸"],
               "纳支": ["未", "巳", "卯", "丑", "亥", "酉"],
               "六亲": ["兄弟", "父母", "官鬼", "兄弟", "妻财", "子孙"],
               "世应": ["", "", "应", "", "", "世"],
               "伏干": ["", "", "", "", "", ""],
               "伏支": ["", "", "", "", "", ""],
               "伏亲": ["", "", "", "", "", ""],
               "世身":"四爻", "月身":"亥", "冲合":"六冲",
               "上卦": "坤", "下卦": "坤", "易序": 2,},
    "100000": {"卦宫": "坤", "宫属": "一世", "卦名": "地雷复",
               "纳干": ["庚", "庚", "庚", "癸", "癸", "癸"],
               "纳支": ["子", "寅", "辰", "丑", "亥", "酉"],
               "六亲": ["妻财", "官鬼", "兄弟", "兄弟", "妻财", "子孙"],
               "世应": ["世", "", "", "应", "", ""],
               "伏干": ["", "乙", "", "", "", ""],
               "伏支": ["", "巳", "", "", "", ""],
               "伏亲": ["", "父母", "", "", "", ""],
               "世身":"初爻", "月身":"子", "冲合":"六合",
               "上卦": "坤", "下卦": "震", "易序": 24,},
    "110000": {"卦宫": "坤", "宫属": "二世", "卦名": "地泽临",
               "纳干": ["丁", "丁", "丁", "癸", "癸", "癸"],
               "纳支": ["巳", "卯", "丑", "丑", "亥", "酉"],
               "六亲": ["父母", "官鬼", "兄弟", "兄弟", "妻财", "子孙"],
               "世应": ["", "世", "", "", "应", ""],
               "伏干": ["", "", "", "", "", ""],
               "伏支": ["", "", "", "", "", ""],
               "伏亲": ["", "", "", "", "", ""],
               "世身":"四爻", "月身":"丑", "冲合":"",
               "上卦": "坤", "下卦": "兑", "易序": 19,},
    "111000": {"卦宫": "坤", "宫属": "三世", "卦名": "地天泰",
               "纳干": ["甲", "甲", "甲", "癸", "癸", "癸"],
               "纳支": ["子", "寅", "辰", "丑", "亥", "酉"],
               "六亲": ["妻财", "官鬼", "兄弟", "兄弟", "妻财", "子孙"],
               "世应": ["", "", "世", "", "", "应"],
               "伏干": ["", "乙", "", "", "", ""],
               "伏支": ["", "巳", "", "", "", ""],
               "伏亲": ["", "父母", "", "", "", ""],
               "世身":"五爻", "月身":"寅", "冲合":"六合",
               "上卦": "坤", "下卦": "乾", "易序": 11,},
    "111100": {"卦宫": "坤", "宫属": "四世", "卦名": "雷天大壮",
               "纳干": ["甲", "甲", "甲", "庚", "庚", "庚"],
               "纳支": ["子", "寅", "辰", "午", "申", "戌"],
               "六亲": ["妻财", "官鬼", "兄弟", "父母", "子孙", "兄弟"],
               "世应": ["应", "", "", "世", "", ""],
               "伏干": ["", "", "", "", "", ""],
               "伏支": ["", "", "", "", "", ""],
               "伏亲": ["", "", "", "", "", ""],
               "世身":"初爻", "月身":"卯", "冲合":"六冲",
               "上卦": "震", "下卦": "乾", "易序": 34,},
    "111110": {"卦宫": "坤", "宫属": "五世", "卦名": "泽天夬",
               "纳干": ["甲", "甲", "甲", "丁", "丁", "丁"],
               "纳支": ["子", "寅", "辰", "亥", "酉", "未"],
               "六亲": ["妻财", "官鬼", "兄弟", "妻财", "子孙", "兄弟"],
               "世应": ["", "应", "", "", "世", ""],
               "伏干": ["", "乙", "", "", "", ""],
               "伏支": ["", "巳", "", "", "", ""],
               "伏亲": ["", "父母", "", "", "", ""],
               "世身":"四爻", "月身":"辰", "冲合":"",
               "上卦": "兑", "下卦": "乾", "易序": 43,},
    "111010": {"卦宫": "坤", "宫属": "游魂", "卦名": "水天需",
               "纳干": ["甲", "甲", "甲", "戊", "戊", "戊"],
               "纳支": ["子", "寅", "辰", "申", "戌", "子"],
               "六亲": ["妻财", "官鬼", "兄弟", "子孙", "兄弟", "妻财"],
               "世应": ["应", "", "", "世", "", ""],
               "伏干": ["", "乙", "", "", "", ""],
               "伏支": ["", "巳", "", "", "", ""],
               "伏亲": ["", "父母", "", "", "", ""],
               "世身":"三爻", "月身":"酉", "冲合":"",
               "上卦": "坎", "下卦": "乾", "易序": 5,},
    "000010": {"卦宫": "坤", "宫属": "归魂", "卦名": "水地比",
               "纳干": ["乙", "乙", "乙", "戊", "戊", "戊"],
               "纳支": ["未", "巳", "卯", "申", "戌", "子"],
               "六亲": ["兄弟", "父母", "官鬼", "子孙", "兄弟", "妻财"],
               "世应": ["", "", "世", "", "", "应"],
               "伏干": ["", "", "", "", "", ""],
               "伏支": ["", "", "", "", "", ""],
               "伏亲": ["", "", "", "", "", ""],
               "世身":"四爻", "月身":"申", "冲合":"",
               "上卦": "坎", "下卦": "坤", "易序": 8,}
}


# 六亲映射表（根据本卦卦宫和地支确定变卦的六亲）
GUA_PALACES = {
    "乾": {"子": "子孙", "寅": "妻财", "辰": "父母", "午": "官鬼", "申": "兄弟", "戌": "父母"},
    "兑": {"巳": "官鬼", "卯": "妻财", "丑": "父母", "亥": "子孙", "酉": "兄弟", "未": "父母"},
    "离": {"卯": "父母", "丑": "妻财", "亥": "官鬼", "酉": "妻财", "未": "子孙", "巳": "兄弟"},
    "震": {"子": "父母", "寅": "兄弟", "辰": "妻财", "午": "子孙", "申": "官鬼", "戌": "妻财"},
    "巽": {"丑": "妻财", "亥": "父母", "酉": "官鬼", "未": "妻财", "巳": "子孙", "卯": "兄弟"},
    "坎": {"寅": "兄弟", "辰": "妻财", "午": "子孙", "申": "官鬼", "戌": "父母", "子": "妻财"},
    "艮": {"辰": "父母", "午": "官鬼", "申": "兄弟", "戌": "父母", "子": "子孙", "寅": "妻财"},
    "坤": {"未": "父母", "巳": "官鬼", "卯": "妻财", "丑": "父母", "亥": "子孙", "酉": "兄弟"}
}

# 六神映射表（根据日干确定六神）
TIAN_GAN_TO_LIU_SHEN = {
    "甲": ["青龙", "朱雀", "勾陈", "螣蛇", "白虎", "玄武"],
    "乙": ["青龙", "朱雀", "勾陈", "螣蛇", "白虎", "玄武"],
    "丙": ["朱雀", "勾陈", "螣蛇", "白虎", "玄武", "青龙"],
    "丁": ["朱雀", "勾陈", "螣蛇", "白虎", "玄武", "青龙"],
    "戊": ["勾陈", "螣蛇", "白虎", "玄武", "青龙", "朱雀"],
    "己": ["勾陈", "螣蛇", "白虎", "玄武", "青龙", "朱雀"],
    "庚": ["螣蛇", "白虎", "玄武", "青龙", "朱雀", "勾陈"],
    "辛": ["螣蛇", "白虎", "玄武", "青龙", "朱雀", "勾陈"],
    "壬": ["白虎", "玄武", "青龙", "朱雀", "勾陈", "螣蛇"],
    "癸": ["白虎", "玄武", "青龙", "朱雀", "勾陈", "螣蛇"]
}


class LiuYaoCalculator:
    """六爻排盘核心计算器"""
    
    def __init__(self):
        self.sixty_four_gua = SIXTY_FOUR_GUA
        self.gua_palaces = GUA_PALACES
        self.tian_gan_to_liu_shen = TIAN_GAN_TO_LIU_SHEN
    
    def validate_yao_data(self, yao_list: List[str]) -> bool:
        """
        验证前端提交的爻位数据格式
        
        Args:
            yao_list: 前端提交的6个三位数组成的爻位列表
            
        Returns:
            bool: 数据格式是否有效
        """
        # 检查列表长度
        if len(yao_list) != 6:
            return False
        
        # 检查每个爻位的格式
        for yao in yao_list:
            if len(yao) != 3 or not yao.isdigit():
                return False
        
        return True
    
    def count_odd_digits(self, yao_list: List[str]) -> List[int]:
        """
        统计每个爻位中奇数的个数
        
        Args:
            yao_list: 6个三位数组成的爻位列表
            
        Returns:
            List[int]: 每个爻位中奇数个数的列表
        """
        if len(yao_list) != 6:
            raise ValueError("爻位列表必须包含6个元素")
        
        odd_counts_list = []
        for yao in yao_list:
            if len(yao) != 3:
                raise ValueError("每个爻位必须是3位数")
            if not yao.isdigit():
                raise ValueError("爻位必须由数字组成")
            
            odd_count = sum(1 for digit in yao if int(digit) % 2 == 1)
            odd_counts_list.append(odd_count)
        return odd_counts_list
    
    def ben_gua_najia(self, odd_counts_list: List[int]) -> Dict[str, Any]:
        """
        本卦纳甲计算
        
        Args:
            odd_counts_list: 奇数个数列表
            
        Returns:
            Dict: 本卦信息字典
        """
        # 将奇数个数转换为阴阳爻（1为阳爻，0为阴爻）
        ben_gua_list = [1 if v % 2 == 1 else 0 for v in odd_counts_list]
        ben_gua_str = ''.join(map(str, ben_gua_list))
        
        # 查找对应的卦象
        ben_gua_info_dict = self.sixty_four_gua.get(ben_gua_str, {})
        ben_gua_info_dict['数列'] = ben_gua_list
        
        return ben_gua_info_dict
    
    def dong_yao(self, odd_counts_list: List[int]) -> tuple[List[int], List[str]]:
        """
        动爻判断
        
        Args:
            odd_counts_list: 奇数个数列表
            
        Returns:
            tuple: (动爻位列表, 动爻符号列表)
        """
        dong_yao_wei_list = [i + 1 for i, v in enumerate(odd_counts_list) if v in (0, 3)]
        
        # 根据奇数个数生成动爻符号列表
        dong_yao_list = []
        for v in odd_counts_list:
            if v == 0:
                dong_yao_list.append('×→')
            elif v == 3:
                dong_yao_list.append('○→')
            else:
                dong_yao_list.append('')
        
        return dong_yao_wei_list, dong_yao_list
    
    def bian_gua_najia(self, odd_counts_list: List[int], ben_gua_info_dict: Dict[str, Any]) -> Dict[str, Any]:
        """
        变卦纳甲计算
        
        Args:
            odd_counts_list: 奇数个数列表
            ben_gua_info_dict: 本卦信息字典
            
        Returns:
            Dict: 变卦信息字典，无动爻时返回空字典
        """
        # 检查是否有动爻
        dong_yao_wei_list = [i + 1 for i, v in enumerate(odd_counts_list) if v in (0, 3)]
        if len(dong_yao_wei_list) == 0:
            return {}
        
        # 计算变卦
        bian_gua_list = [1 if v == 0 else 0 if v in (2, 3) else 1 for v in odd_counts_list]
        bian_gua_str = ''.join(map(str, bian_gua_list))
        
        # 查找对应的卦象
        bian_gua_info_dict = self.sixty_four_gua.get(bian_gua_str, {})
        
        # 重新计算变卦六亲
        ben_gua_gong = ben_gua_info_dict.get('卦宫', '未知卦宫')
        if ben_gua_gong in self.gua_palaces:
            bian_gua_liuqin_list = []
            for dizhi in bian_gua_info_dict.get('纳支', []):
                liuqin = self.gua_palaces[ben_gua_gong].get(dizhi, '未知六亲')
                bian_gua_liuqin_list.append(liuqin)
            bian_gua_info_dict['六亲'] = bian_gua_liuqin_list
        
        bian_gua_info_dict['数列'] = bian_gua_list
        
        return bian_gua_info_dict
    
    def calculate_liu_shen(self, day_gan: str) -> List[str]:
        """
        计算六神分布
        
        Args:
            day_gan: 日干（甲、乙、丙、丁、戊、己、庚、辛、壬、癸）
            
        Returns:
            List[str]: 六神分布列表（从初爻到上爻）
        """
        valid_day_gans = ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"]
        if day_gan not in valid_day_gans:
            raise ValueError(f"无效的日干: {day_gan}，必须是{valid_day_gans}中的一个")
        
        return self.tian_gan_to_liu_shen.get(day_gan, [])
    
    def calculate_paipan(self, yao_list: List[str], day_gan: str) -> Dict[str, Any]:
        """
        完整的六爻排盘计算
        
        Args:
            yao_list: 起卦列表数据（6个三位数）
            day_gan: 日干信息
            
        Returns:
            Dict: 完整的排盘结果
        """
        # 1. 统计奇数个数
        odd_counts_list = self.count_odd_digits(yao_list)
        
        # 2. 计算本卦
        ben_gua_info = self.ben_gua_najia(odd_counts_list)
        
        # 3. 判断动爻
        dong_yao_wei_list, dong_list = self.dong_yao(odd_counts_list)
        
        # 4. 计算变卦（如果有动爻）
        bian_gua_info = self.bian_gua_najia(odd_counts_list, ben_gua_info)
        
        # 5. 计算六神
        liu_shen_list = self.calculate_liu_shen(day_gan)
        
        # 6. 构建完整结果
        result = {
            "yao_list": yao_list,
            "odd_counts": odd_counts_list,
            "ben_gua": ben_gua_info,
            "dong_yao": {
                "positions": dong_yao_wei_list,
                "symbols": dong_list
            },
            "bian_gua": bian_gua_info,
            "liu_shen": liu_shen_list,
            "day_gan": day_gan
        }
        
        return result
    
    def get_hexagram_list(self) -> List[Dict[str, Any]]:
        """
        获取六十四卦列表
        
        Returns:
            List[Dict]: 六十四卦信息列表
        """
        hexagram_list = []
        for gua_code, gua_info in self.sixty_four_gua.items():
            hexagram_info = {
                "code": gua_code,
                "name": gua_info.get("卦名", ""),
                "palace": gua_info.get("卦宫", ""),
                "nature": gua_info.get("宫属", ""),
                "upper": gua_info.get("上卦", ""),
                "lower": gua_info.get("下卦", "")
            }
            hexagram_list.append(hexagram_info)
        
        return hexagram_list